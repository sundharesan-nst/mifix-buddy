<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Bot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <style>
      
      body {
    font-family: "Poppins", sans-serif;
    background-color: #1d1d33;
    color: white;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background-color: #1d1d33;
  }

  h2 {
    text-align: center;
    color: black;
    background-color: white;
    padding: 5px;
    border-radius: 5px;
    font-weight: 600;
    display: inline-block;
  }

  .user-menu {
    position: absolute;
    top: 10px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
  }

  .user-icon {
    font-size: 24px;
    background-color: #93107e;
    color: white;
    padding: 10px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background-color 0.3s ease;
  }

  .user-icon:hover {
    background-color: #7e0e69;
  }

  .dropdown {
    position: absolute;
    top: 50px;
    right: 20px;
    background-color: #2e2e3e;
    color: white;
    padding: 10px;
    border-radius: 8px;
    width: 200px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
    display: none;
    animation: fadeIn 0.3s ease;
    z-index: 1000;
  }

  .dropdown p {
    font-weight: bold;
    font-size: 16px;
    margin: 0;
    padding-bottom: 8px;
    color: #d1d1d1;
    border-bottom: 1px solid #444;
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    padding: 10px;
    cursor: pointer;
    color: #d1d1d1;
    transition: background-color 0.3s ease;
    border-radius: 5px;
    gap: 8px;
  }

  .dropdown-item:hover {
    background-color: #41414d;
  }

  .dropdown-item svg {
    width: 16px;
    height: 16px;
  }

  .logout-btn {
    background-color: #d9534f;
    color: white;
    padding: 8px;
    width: 100%;
    text-align: center;
    text-decoration: none;
    border-radius: 5px;
    margin-top: 10px;
    transition: background-color 0.3s ease;
  }

  .logout-btn:hover {
    background-color: #c9302c;
  }

  .new-chat-btn {
    display: flex;
    align-items: center;
    background-color: #1e90ff;
    padding: 8px;
    color: white;
    border-radius: 5px;
    text-decoration: none;
    width: 100%;
    text-align: center;
    transition: background-color 0.3s ease;
    margin-top: 10px;
  }

  .new-chat-btn:hover {
    background-color: #1c86e0;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
      
      #new{
        margin-right: 100px;
        cursor: pointer;
        padding: 9px;
        background-color: red;
        color: white;
        width: 100%;
        border-radius: 10px;

      }
      body {
        font-family: "Poppins", sans-serif;
        background-color: #1d1d33;
        color: white;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #1d1d33;
      }

      h2 {
        text-align: center;
        color: black;
        background-color: white;
        padding: 5px;
        border-radius: 5px;
        font-weight: 600;
        display: inline-block;
      }

      .user-menu {
        position: absolute;
        top: 10px;
        right: 20px;
        color: white;
        
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }
#user{
  background-color: #93107e;
}
      .user-icon {
        font-size: 24px;
        background-color: #93107e;
        padding: 10px;
        border-radius: 50%;
        display: flex;
        margin-right: 100px;
        justify-content: center;
        align-items: center;
      }

      .dropdown {
        position: absolute;
        top: 45px;
        right: 20px;
        background-color: #2e2e3e;
        color: white;
        padding: 10px;
        border-radius: 8px;
        width: 180px;
        display: none;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .dropdown p {
        margin: 0;
        font-weight: bold;
        font-size: 14px;
      }

      .logout-btn {
        background-color: #d9534f;
        color: white;
        padding: 8px;
        width: 90%;
        text-align: center;
        text-decoration: none;
        border-radius: 5px;
        margin-top: 10px;
        display: block;
      }

      .logout-btn:hover {
        background-color: #c9302c;
      }

      .dropdown::before {
        content: "";
        position: absolute;
        top: -8px;
        right: 10px;
        border-width: 8px;
        border-style: solid;
        border-color: transparent transparent #2e2e3e transparent;
      }
body{
  overflow: scroll;
}
      #user{
        color: white;
      }
      .container #chat-box {
        font-family: sans-serif;
      }
      p {
        font-size: 17px;
        font-weight: 700;
        font-family: "Poppins", sans-serif;
  font-weight: 500;
  font-style: normal;
      }

      #res {
        z-index: 1;
        background-color: grey;
        width: 400px;
        font-size: 17px;
        margin-left: 88px;
        color: white;
        padding: 20px;
        border-radius: 10px;
        animation: left-msg-glow 1s ease infinite alternate;
      }
      h2 {
        margin-top: -10px;
        width: 90%;
        background-color: white;
      }
      #res p {
        font-weight: normal;
      }
      body {
        overflow-y: hidden;
      }

      @keyframes left-msg-glow {
        0% {
          box-shadow: rgba(193, 192, 193, 0.308) 0px 0px 0px;
        }
        50% {
          box-shadow: rgb(188, 184, 188) 0px 0px 10px;
        }
        100% {
          box-shadow: rgb(193, 192, 193) 0px 0px 0px;
        }
      }
      @keyframes right-msg-glow {
        0% {
          box-shadow: rgba(243, 28, 214, 0.199) 0px 0px 0px;
        }
        50% {
          box-shadow: rgb(239, 101, 221) 0px 0px 10px;
        }
        100% {
          box-shadow: rgb(243, 28, 214) 0px 0px 0px;
        }
      }

      #user {
        animation: right-msg-glow 1s ease infinite alternate;
        margin-left: 70%;
        word-wrap: break-word;
        max-width: 450px;
        padding: 15px;
      }
      #user p p {
        font-size: 16px;
      }
      .user-message {
        color: white; /* Dark text color for better readability */
        background-color: #93107e; /* Light grey background */
        padding: 5px;
        border-radius: 5px;
        margin-bottom: 2px; /* Adds a little space between consecutive messages */
        text-align: right;
        max-width: 80%; /* Adjust this as needed */
        margin-left: auto;
      }

      /* Optionally style the "You:" part in bold */
      .user-message strong {
        font-weight: bold;
      }

      .bot-message {
        color: white; /* Set the text color to white */
        background-color: #fcfafa; /* Optional: Change the background to improve contrast */
        padding: 5px;
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb {
        background: #0a0a47;
        border-radius: 2px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        padding: 10px;
      }
      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #1d1d33;
      }
      /* Optional: Ensure strong contrast if changing the bot message background */
      .bot-message strong {
        color: #fff;
      }

      body {
        background-color: #1d1d33;
        background-image: url("");
      }
      h2 {
        background-color: white;
        padding: 4px;
        border-radius: 6px;
        margin-left: px;
        font-weight: 600;
        text-align: center;
      }
      #xx {
        color: white;
        font-weight: 700;
        font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
          sans-serif;
      }
      .container {
        padding: 20px;

        margin: 0 auto;
        margin-top: px; /* Consider if this negative margin is necessary, as it might cause layout issues */
        border-radius: 5px;
        background-color: #1d1d33;
        max-width: 90%; /* Set a max-width to ensure container does not stretch too wide on larger screens */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
      }

      .white-text {
        color: white;
      }
      .chat-box {
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
        background-color: #1d1d33;
width: 90%;
        height: 68vh;
        overflow: auto;
      }
      .input-box {
        display: flex;
        background-color: #f1f1f1;
        padding: 20px;
        position: absolute;
        width: 85%; /* Default width */
        bottom: 0; /* Position it at the bottom of the screen */
        left: 50%; /* Centering technique */
        transform: translateX(-50%); /* Centering technique */
        z-index: 10;
        border-radius: 5%;
        box-sizing: border-box; /* Ensure padding is included in width */
      }
      

      /* Adjustments for smaller screens */
      @media (max-width: 768px) {
        .input-box {
          width: 95%; /* Increase width to use more of the screen */
          padding: 15px; /* Slightly reduce padding */
          bottom: 10px; /* Adjust position if needed */
        }
      }

      /* Further adjustments for very small screens */
      @media (max-width: 480px) {
        .input-box {
          flex-direction: column; /* Stack input and button vertically */
          padding: 10px;
        }
        .input-box input[type="submit"] {
          width: 100%; /* Make the submit button full width */
          margin-top: 10px; /* Add space between the text input and submit button */
          margin-left: 0; /* Reset margin left */
        }
      }

      .input-box input[type="text"] {
        flex: 1;

        color: white;
        padding: 10px;
        background-color: #1d1d33;
        border: none;
        border-radius: 15%;
        border-radius: 5px;
      }
      .input-box input[type="submit"] {
        padding: 10px 20px;
        margin-left: 10px;
        background-color: #93107e;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .typewriter {
        color: white;
        overflow: hidden; /* Ensures the content is not revealed until the animation */
        /* The typwriter cursor */
        white-space: nowrap; /* Keeps the content on a single line */
        margin: 0 auto; /* Gives that scrolling effect as the typing happens */
        letter-spacing: 0.15em; /* Adjust as needed */
        animation: typing 3.5s steps(40, end),
          blink-caret 0.75s step-end infinite;
      }

      /* The typing effect */
      @keyframes typing {
        from {
          width: 0;
        }
        to {
          width: 100%;
        }
      }
      .logout-btn {
  background-color: #d9534f;
  color: white;
  padding: 5px 10px;
  text-decoration: none;
  border-radius: 5px;
  margin-top: 10px;
}
.logout-btn:hover {
  background-color: #c9302c;
}
input[type="file"]:hover {
  cursor: pointer;
  outline: 2px solid #93107e; /* Optional: Highlight color */
}
input[type="file"]:focus {
  outline: 2px solid #1e90ff; /* Optional: Focus color */
  outline-offset: 2px;
}
input[type="file"] {
  background-color: #1d1d33; /* Match your background */
  color: white; /* Text color */
  border: 1px solid #93107e; /* Optional: Border */
  border-radius: 5px;
  padding: 5px;
}
    </style>
  </head>
  <body>
    <div class="container">
      <h2 color="black">MiFix Buddy</h2>
      <div class="user-menu" onclick="toggleDropdown()">
        <div class="user-icon">ðŸ‘¤</div>
      </div>
    
      <div class="dropdown" id="userDropdown">
        <p>Welcome, {{ user_id }}</p>
        <div class="dropdown-item" onclick="startNewChat()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm1 11h-2v2a1 1 0 0 1-2 0v-2H7a1 1 0 0 1 0-2h2V9a1 1 0 0 1 2 0v2h2a1 1 0 0 1 0 2Z" />
          </svg>
          <span>New Chat</span>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
      </div>
    </div>
    
    <div class="chat-box" id="chat-box">
      <!-- Chat history will be rendered here by JavaScript -->
    </div>
    
    <form id="chat-form" enctype="multipart/form-data">
      <div class="input-box">
        <input type="text" id="question" placeholder="Ask something..." />
        <div style="width: 5%;display: flex; justify-content: center;align-items: center;">
          <label for="image"><svg viewBox="0 0 24 24" fill="none"  width="25" 
            height="25"  xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M5.25 9C5.25 5.27208 8.27208 2.25 12 2.25C15.7279 2.25 18.75 5.27208 18.75 9V16C18.75 16.4142 18.4142 16.75 18 16.75C17.5858 16.75 17.25 16.4142 17.25 16V9C17.25 6.1005 14.8995 3.75 12 3.75C9.10051 3.75 6.75 6.10051 6.75 9V17C6.75 18.7949 8.20507 20.25 10 20.25C11.7949 20.25 13.25 18.7949 13.25 17V10C13.25 9.30964 12.6904 8.75 12 8.75C11.3096 8.75 10.75 9.30964 10.75 10V16C10.75 16.4142 10.4142 16.75 10 16.75C9.58579 16.75 9.25 16.4142 9.25 16V10C9.25 8.48122 10.4812 7.25 12 7.25C13.5188 7.25 14.75 8.48122 14.75 10V17C14.75 19.6234 12.6234 21.75 10 21.75C7.37665 21.75 5.25 19.6234 5.25 17V9Z" fill="#030D45"></path> </g></svg></label>
          <input type="file" style="visibility: hidden; width: 0%;" id="image" accept="image/*" />
        </div>
        <input type="submit" value="Send" />
      </div>
    </form>    
    
    <script>
      // Fetch the chat history data from server-side variable
      const chatHistory = {{ chat_history | tojson }};
    
      // Select the chat box to display messages
      const chatBox = document.getElementById("chat-box");
    
      // Render the chat history using JavaScript only
      chatHistory.forEach((chat) => {
        const userMessage = document.createElement("div");
        userMessage.id = "user";
        userMessage.innerHTML = `<strong>User:</strong> ${chat.question}`;
        chatBox.appendChild(userMessage);
    
        if (chat.image_url) {
          const userImage = document.createElement("img");
          userImage.src = chat.image_url;
          userImage.style.maxWidth = "150px";
          userImage.style.borderRadius = "5px";
          chatBox.appendChild(userImage);
        }
    
        const botMessage = document.createElement("div");
        botMessage.id = "res";
        typeOutResponse(botMessage, chat.answer);
        chatBox.appendChild(botMessage);
      });
    
      // Function to format line breaks for HTML display
      function formatToHTML(inputText) {
        return inputText.replace(/\n/g, "<br>");
      }
    
      function typeOutResponse(element, htmlContent) {
        htmlContent = formatToHTML(htmlContent);
        element.innerHTML = "";
    
        // Split the HTML content into an array of characters
        let contentArray = htmlContent.split("");
        let cursorPosition = 0;
        let tempContent = "";
        let isTag = false;
        let tagBuffer = "";
    
        let interval = setInterval(() => {
          if (cursorPosition < contentArray.length) {
            let char = contentArray[cursorPosition];
            tempContent += char;
    
            if (char === "<") {
              isTag = true;
              tagBuffer = "";
            }
    
            if (isTag) {
              tagBuffer += char;
              if (char === ">") {
                isTag = false;
              }
            }
    
            if (!isTag) {
              element.innerHTML = tempContent;
            }
    
            cursorPosition++;
          } else {
            element.innerHTML = htmlContent;
            clearInterval(interval);
          }
        }, 10);
      }
    
      document
        .getElementById("chat-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();
    
          const question = document.getElementById("question").value.trim();
          const image = document.getElementById("image").files[0];
          const chatBox = document.getElementById("chat-box");
    
          // Validation: Ensure the question is not empty if an image is uploaded
          if (!question && image) {
            alert("Please type your question along with the uploaded image.");
            return; // Stop further execution
          }else if (question && image){
            const userMessage = document.createElement("div");

            userMessage.id = "user"

            const blobUrl = URL.createObjectURL(image);

            userMessage.innerHTML = `
              <div  style="background-color: #93107e; margin: 10px 0; border-radius: 10px; padding: 10px; color: white;">
                <p id="xx" style="margin: 0; font-weight: bold;">User</p>
                <p class="white-text" style="margin-top: 5px; font-size: 16px;">${question}</p>
                <img src="${blobUrl}" style="max-width: 150px; border-radius: 5px; margin-top: 10px;" alt="Uploaded Image"/>
              </div>
            `;

            chatBox.appendChild(userMessage);


          
          }
    
          // Display user's question
          if (question && !image) {
            const userMessage = document.createElement("div");
            userMessage.innerHTML =
              '<div id="user" style="background-color:#93107e;margin:right;border-Radius:10px"><p id="xx">User<p class="white-text" style="text-align:;margin-top:-10px;font-size:16px;"> ' +
              question +
              "</p></p></div>";
            chatBox.appendChild(userMessage);
          }
    
          
    
          // Clear the input fields
          document.getElementById("question").value = "";
          document.getElementById("image").value = "";
    
          // Prepare data to send to the server
          const formData = new FormData();
          formData.append("question", question);
          if (image) {
            formData.append("image", image);
          }
    
          // Make a request to the server
          fetch("/search", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              const botMessageDiv = document.createElement("div");
              botMessageDiv.id = "res";
              chatBox.appendChild(botMessageDiv);
    
              const responseText = data.answer || "No response";
              typeOutResponse(botMessageDiv, responseText);
    
              // Scroll to the bottom of the chat box automatically
              chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch((error) => console.error("Error:", error));
        });
    
      function toggleDropdown() {
        const dropdown = document.getElementById("userDropdown");
        dropdown.style.display =
          dropdown.style.display === "none" || dropdown.style.display === ""
            ? "block"
            : "none";
      }
    
      // Close the dropdown if clicked outside
      window.onclick = function (event) {
        if (
          !event.target.closest(".user-menu") &&
          !event.target.closest(".dropdown")
        ) {
          document.getElementById("userDropdown").style.display = "none";
        }
      };
    
      function startNewChat() {
        document.getElementById("chat-box").innerHTML = "";
        chatHistory.length = 0;
    
        // Send a request to the backend to clear chat history
        fetch("/clear_chat_history", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ user_id: "{{ user_id }}" }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("Chat history cleared.");
            } else {
              console.error("Failed to clear chat history.");
            }
          })
          .catch((error) => console.error("Error:", error));
      }
    </script>
    
  </body>
</html>